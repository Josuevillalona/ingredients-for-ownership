rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Coaches collection - only allow users to read/write their own profile
    match /coaches/{coachId} {
      allow read, write: if request.auth != null && request.auth.uid == coachId;
    }
    
    // Ingredient Documents collection - Layer 1 simplified architecture
    match /ingredient-documents/{documentId} {
      // Coaches can read/write their own documents
      allow read, write: if request.auth != null && 
        resource.data.coachId == request.auth.uid;
      
      // Coaches can create documents for themselves
      allow create: if request.auth != null && 
        request.resource.data.coachId == request.auth.uid;
      
      // Public read access for shared documents via shareToken
      // This allows clients to view shared ingredient documents without authentication
      allow read: if request.auth == null && 
        resource.data.shareToken != null;
      
      // Public write access for client tracking updates via shareToken
      // Only allow updates to the ingredients array and updatedAt for tracking purposes
      allow update: if request.auth == null && 
        resource.data.shareToken != null &&
        // Only allow changes to the ingredients array and updatedAt (client tracking)
        request.resource.data.keys().hasAll(resource.data.keys()) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ingredients', 'updatedAt']) &&
        // Ensure the ingredients array structure is preserved
        request.resource.data.ingredients.size() == resource.data.ingredients.size();
    }
    
    // Food Categories collection - read-only global data
    match /food-categories/{categoryId} {
      allow read: if true; // Public read access for all food categories
      allow write: if false; // No write access (seed data only)
    }
    
    // Foods collection - global shared database
    match /foods/{foodId} {
      // Public read access for client shared plan views
      allow read: if true;
      // Only authenticated coaches can write/modify foods
      allow write: if request.auth != null;
    }
    
    // Legacy collections for backward compatibility during transition
    // These can be removed after full migration to Layer 1 architecture
    
    // Clients collection - only allow coaches to access their own clients
    match /clients/{clientId} {
      allow read, write: if request.auth != null && 
        resource.data.coachId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.coachId == request.auth.uid;
    }
    
    // Plans collection - only allow coaches to access plans for their clients
    match /plans/{planId} {
      allow read, write: if request.auth != null && 
        resource.data.coachId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.coachId == request.auth.uid;
      
      // Allow public read access for shared plans using shareToken
      allow read: if request.auth == null && 
        resource.data.shareToken != null;
    }
    
    // Deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
